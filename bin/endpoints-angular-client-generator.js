#!/usr/bin/env node
/**
 * endpoints-angular-client-generator <https://github.com/krico/endpoints-angular-client-generator>
 *
 * Copyright (c) 2015 Christian Asmussen.
 * Released under the MIT license.
 */

'use strict';

var PROGRAM_NAME = 'endpoints-angular-client-generator';

var fs = require('fs');
var path = require('path');
var program = require('commander');
var sprintf = require('sprintf-js').sprintf;
var request = require('request');
var isUrl = require('is-url');
var pkg = require(path.dirname(__filename) + '/../package.json');
var log = require(path.dirname(__filename) + '/../lib/log');
var RestDescription = require(path.dirname(__filename) + '/../lib/rest-description');
var Context = require(path.dirname(__filename) + '/../lib/context');
var Generator = require(path.dirname(__filename) + '/../lib/generator');

var config = {version: pkg.version};

function document(val) {
    if (isUrl(val)) {
        config.documentSrc = val;
        config.document = val;
    } else {
        config.documentSrc = val;
        config.document = path.resolve(val);
    }
}

function output(val) {
    config.output = path.resolve(val);
}

function moduleName(val) {
    config.moduleName = val;
}

function providerName(val) {
    config.providerName = val;
}

program
    .version(pkg.version)
    .usage('[options] -d <file> -o <file>')
    .option('-d, --document <file>', 'Read discovery document from <file>', document)
    .option('-o, --output-dir <dir>', 'Write generated code files to <dir>', output)
    .option('-s, --split-module', 'Split generated code into two files, one for the module another for provider')
    .option('-m, --module-name <name>', 'Override default module name to be "angular.module(<name>)"', moduleName)
    .option('-p, --provider-name <name>', 'Override default provider/service name to be "angular.module().provider(<name>)"', providerName)
    .parse(process.argv);

function info(msg) {
    console.info(msg);
    log.debug(msg);
}

function checkUrlDocument(cb) {
    request({
        method: 'GET',
        url: config.document
    }, function (error, response, body) {

        if (!error && response.statusCode == 200) {
            config.document = JSON.parse(body);
            cb();
        } else if (error) {
            console.error('ERROR: Failed to get url: "' + config.document + '": ' + error + '!');
            process.exit(1);
        }
    });
}

function checkFileDocument(cb) {
    try {
        var stats = fs.statSync(config.document);
        if (!(stats && stats.isFile())) {
            console.error('ERROR: The path "' + config.document + '" must be a file!');
            process.exit(1);
        }
    } catch (e) {
        console.error('ERROR: The path "' + config.document + '" must be a file!');
        process.exit(1);
    }
    cb();
}

function checkDocument(cb) {
    if (typeof config.document === 'undefined') {
        console.error('ERROR: You must specify a discovery document "--document"!');
        process.exit(1);
    }
    if (isUrl(config.document)) {
        checkUrlDocument(cb);
    } else {
        checkFileDocument(cb);
    }
}
function checkOutput() {
    if (typeof config.output === 'undefined') {
        console.error('ERROR: You must specify an output directory "--output-dir"!');
        process.exit(1);
    }
    try {
        var stats = fs.statSync(config.output);
        if (!(stats && stats.isDirectory())) {
            console.error('ERROR: The path "' + config.output + '" must be a directory!');
            process.exit(1);
        }
    } catch (e) {
        console.error('ERROR: The path "' + config.output + '" must exist and be a directory!');
        process.exit(1);
    }
}

function configure() {
    config.splitModule = program.splitModule;

//Set global config
    Context.config(config);
    if (!program.suppressHeader) {
        Context.header(
            sprintf('/**\n * Generated by %s (version %s)\n * Arguments:\n *   %s %s\n */\n',
                PROGRAM_NAME, pkg.version, PROGRAM_NAME, process.argv.splice(2).join(' ')
            )
        );
    }
}

function generate() {
    log.debug('Reading RestDescription from [' + config.documentSrc + ']');
    var restDescription = new RestDescription(config.document);

    try {
        restDescription.validate();
    } catch (e) {
        log.warn('Discovery document [' + config.documentSrc + '] is invalid: ' + e);
        process.exit(2);
    }
    info('Validated discovery document: \'' + config.documentSrc + '\'');
    info('\tId      : ' + restDescription.id());
    info('\tName    : ' + restDescription.name());
    info('\tVersion : ' + restDescription.version());

    var generator = new Generator(restDescription, config);
    generator.generate(function (e) {
        if (e) {
            log.warn('Failed to generate: ' + e);
            process.exit(3);
        }
    });
}

log.debug('Started generation of [' + config.document + ']');

checkDocument(function () {
    checkOutput();
    configure();
    generate();
});